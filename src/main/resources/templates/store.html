<!DOCTYPE html>
<html lang="el" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${store.name} + ' - ÎœÎµÎ½Î¿Ï'">Store Menu</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .container { display: flex; gap: 20px; }
        .menu-section { flex: 2; }
        .cart-section { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9; position: sticky; top: 20px; height: fit-content; }
        .menu-item { border-bottom: 1px solid #eee; padding: 10px 0; list-style: none; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .btn-order { background-color: #ff6f61; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .btn-checkout { background-color: #28a745; color: white; border: none; padding: 10px; width: 100%; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .error-msg { color: red; background: #ffe6e6; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .btn-add-addr { display: inline-block; margin-top: 5px; color: blue; text-decoration: underline; font-size: 0.9em; }

        /* Î Î¬Î½ÎµÎ» Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï„Î¿ Status */
        .owner-panel {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-status { padding: 10px 20px; font-weight: bold; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-add-product { background-color: #28a745; color: white; padding: 8px 12px; text-decoration: none; border-radius: 4px; font-weight: bold; }
        .owner-actions a { margin-right: 10px; font-weight: bold; text-decoration: none; }
    </style>
</head>
<body>
<header>
    <h1 th:text="${store.name}">ÎŒÎ½Î¿Î¼Î± ÎšÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚</h1>
    <nav>
        <a sec:authorize="hasRole('OWNER')" th:href="@{/owner/dashboard}" style="color: gold; font-weight: bold;">ğŸ›ï¸ Dashboard</a>
        <span sec:authorize="hasRole('OWNER')"> | </span>

        <a th:href="@{/profile(returnToStore=${store.id})}">Î ÏÎ¿Ï†Î¯Î»</a> |
        <a th:href="@{/}">Î‘ÏÏ‡Î¹ÎºÎ®</a>
    </nav>
</header>

<main class="container">
    <section class="menu-section">
        <div th:if="${param.error}" class="error-msg">
            <strong>Î£Ï†Î¬Î»Î¼Î±:</strong> <span th:text="${param.error}"></span>
        </div>

        <div th:if="${isOwner}" class="owner-panel">
            <div>
                <strong style="color:#0d47a1;">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎšÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚</strong><br>
                ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·:
                <span th:text="${store.open ? 'Î‘ÎÎŸÎ™Î§Î¤ÎŸ' : 'ÎšÎ›Î•Î™Î£Î¤ÎŸ'}"
                      th:style="${store.open ? 'color: green; font-weight:bold;' : 'color: red; font-weight:bold;'}"></span>
            </div>

            <form th:action="@{/store/{id}/status(id=${store.id})}" method="post" style="margin:0;">
                <input type="hidden" name="open" th:value="${!store.open}" />
                <button type="submit" class="btn-status"
                        th:text="${store.open ? 'ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿' : 'Î†Î½Î¿Î¹Î³Î¼Î±'}"
                        th:styleappend="${store.open ? 'background-color: #d32f2f;' : 'background-color: #388e3c;'}">
                </button>
            </form>
        </div>

        <div class="store-info">
            <p><strong>Î ÎµÏÎ¹Î¿Ï‡Î®:</strong> <span th:text="${store.area}"></span> - <span th:text="${store.address}"></span></p>
            <p><strong>ÎšÎ¿Ï…Î¶Î¯Î½Î±:</strong> <span th:text="${store.cuisineType}"></span></p>
            <p><strong>Î•Î»Î¬Ï‡Î¹ÏƒÏ„Î· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±:</strong> <span id="minOrder" th:text="${store.minOrderAmount}">0.00</span>â‚¬</p>
        </div>
        <hr>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>ÎœÎµÎ½Î¿Ï</h2>
            <a th:if="${isOwner}" th:href="@{/product/new(storeId=${store.id})}" class="btn-add-product">+ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î¹Î¬Ï„Î¿Ï…</a>
        </div>

        <ul th:if="${products != null and !products.isEmpty()}">
            <li th:each="product : ${products}" class="menu-item">
                <h3 th:text="${product.name}" style="margin-bottom:5px;"></h3>
                <p th:text="${product.description}" style="font-style:italic; color:#555; margin-top:0;"></p>
                <p>
                    <strong>Î¤Î¹Î¼Î®:</strong> â‚¬<span th:id="'price-' + ${product.id}" th:text="${product.price}"></span>
                    <span th:if="${dollarRate != null}" style="color:gray; font-size:0.9em;">(~<span th:text="${#numbers.formatDecimal(product.price * dollarRate, 1, 2)}"></span>$)</span>
                </p>

                <div th:if="${isOwner}" class="owner-actions">
                    <a th:href="@{/product/edit/{id}(id=${product.id})}" style="color: blue;">âœï¸ Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</a>
                    <a th:href="@{/product/delete/{id}(id=${product.id})}" style="color: red;" onclick="return confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;')">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î®</a>
                </div>

                <button th:if="${store.open and !isOwner and product.available}" class="btn-order"
                        th:onclick="addToCart( [[${product.id}]], [[${product.name}]], [[${product.price}]])">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                <span th:if="${!store.open}" style="color:red; font-weight:bold;">ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ</span>
            </li>
        </ul>
        <div th:if="${products == null or products.isEmpty()}"><p>Î¤Î¿ Î¼ÎµÎ½Î¿Ï ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿.</p></div>
    </section>

    <aside class="cart-section">
        <h3>Î¤Î¿ ÎšÎ±Î»Î¬Î¸Î¹ Î¼Î¿Ï…</h3>
        <div id="cart-items"><p>Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿</p></div>
        <hr>
        <p><strong>Î£ÏÎ½Î¿Î»Î¿: <span id="cart-total">0.00</span>â‚¬</strong></p>

        <form th:action="@{/orders/checkout}" method="post" id="order-form" style="display:none;" onsubmit="return validateOrder()">
            <input type="hidden" name="storeId" th:value="${store.id}">
            <div id="hidden-inputs"></div>
            <label>Î¤ÏÏ€Î¿Ï‚ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚:</label>
            <select name="type" id="orderType" onchange="toggleAddress()" style="width: 100%; padding: 5px; margin-bottom: 10px;">
                <option value="PICKUP">Î Î±ÏÎ±Î»Î±Î²Î® (Pickup)</option>
                <option value="DELIVERY">Î Î±ÏÎ¬Î´Î¿ÏƒÎ· (Delivery)</option>
            </select>
            <div id="address-div" style="display:none; margin-bottom: 15px; padding-top: 10px; border-top: 1px dashed #ccc;">
                <label><strong>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:</strong></label>
                <div th:if="${not #lists.isEmpty(addresses)}">
                    <select name="addressId" id="addressSelect" style="width: 100%; padding: 5px;">
                        <option th:each="addr : ${addresses}" th:value="${addr.id}" th:text="${addr.street + ' ' + addr.city}"></option>
                    </select>
                    <br><a th:href="@{/profile(returnToStore=${store.id})}" class="btn-add-addr">+ ÎÎ­Î± Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</a>
                </div>
                <div th:if="${#lists.isEmpty(addresses)}" style="color: #d9534f; background: #fff5f5; padding: 5px;">
                    <a th:href="@{/profile(returnToStore=${store.id})}" class="btn-add-addr">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚</a>
                    <input type="hidden" id="noAddressFlag" value="true">
                </div>
            </div>
            <button type="submit" class="btn-checkout">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·</button>
        </form>
        <button onclick="clearCart()" style="margin-top: 10px; background: #ccc; border: none; padding: 5px; width: 100%; cursor: pointer;">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
    </aside>
</main>

<script th:inline="javascript">
    let cart = JSON.parse(localStorage.getItem('streetfood_cart')) || {};
    updateCartUI();
    toggleAddress();

    function addToCart(id, name, price) {
        if (!cart[id]) { cart[id] = { name: name, price: price, qty: 1 }; }
        else { cart[id].qty += 1; }
        saveCart(); updateCartUI();
    }
    function saveCart() { localStorage.setItem('streetfood_cart', JSON.stringify(cart)); }
    function clearCart() { cart = {}; saveCart(); updateCartUI(); }

    function toggleAddress() {
        const type = document.getElementById('orderType').value;
        document.getElementById('address-div').style.display = (type === 'DELIVERY') ? 'block' : 'none';
    }

    function validateOrder() {
        if (document.getElementById('orderType').value === 'DELIVERY' && document.getElementById('noAddressFlag')) {
            alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·!"); return false;
        }
        const min = parseFloat(document.getElementById('minOrder').innerText.replace(',', '.')) || 0;
        const total = parseFloat(document.getElementById('cart-total').innerText.replace(',', '.')) || 0;
        if (total < min) { alert("Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÎµÎ¯Î½Î±Î¹ ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ Ï„Î¿ ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î¿ ÏŒÏÎ¹Î¿ (" + min + "â‚¬)."); return false; }
        return true;
    }

    function updateCartUI() {
        const cartDiv = document.getElementById('cart-items');
        let html = '', total = 0, inputs = '';
        for (let id in cart) {
            let item = cart[id];
            let t = item.price * item.qty;
            total += t;
            html += `<div class="cart-item"><span>${item.name} x${item.qty}</span><span>${t.toFixed(2)}â‚¬</span></div>`;
            inputs += `<input type="hidden" name="items[${id}]" value="${item.qty}">`;
        }
        cartDiv.innerHTML = Object.keys(cart).length === 0 ? '<p>Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿</p>' : html;
        document.getElementById('cart-total').innerText = total.toFixed(2);
        document.getElementById('hidden-inputs').innerHTML = inputs;
        document.getElementById('order-form').style.display = total > 0 ? 'block' : 'none';
    }
</script>
</body>
</html>